worker_processes  1;

env AUTH0_DOMAIN;
env AUTH0_AUDIENCE;

events {
    worker_connections  1024;
}

http {
    # Log format
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;
    error_log   /var/log/nginx/error.log warn;

    # Lua shared dictionaries for OpenID Connect (JWKS & discovery cache)
    lua_shared_dict discovery 1m;
    lua_shared_dict jwks 1m;
    lua_ssl_trusted_certificate /etc/pki/tls/certs/ca-bundle.crt;
    lua_ssl_verify_depth 5;
    resolver 127.0.0.11 valid=30s ipv6=off;

    # Simple upstreams for each microservice
    upstream user_service {
        server user-service:8080;
    }
    upstream location_service {
        server location-service:8080;
    }
    upstream messaging_service {
        server messaging-service:8080;
    }
    upstream matching_service {
        server matching-service:8080;
    }

    server {
        listen 80;

        # Health check
        location /healthz {
            return 200 'API Gateway OK';
            add_header Content-Type text/plain;
        }

        # Route requests by path prefix
        location /user/ {
            access_by_lua_file /etc/nginx/oidc.lua;
            proxy_set_header Host $host;
            proxy_pass http://user_service$request_uri;
        }
        location /location/ {
            access_by_lua_file /etc/nginx/oidc.lua;
            proxy_set_header Host $host;
            proxy_pass http://location_service$request_uri;
        }
        location /messaging/ {
            access_by_lua_file /etc/nginx/oidc.lua;
            proxy_set_header Host $host;
            proxy_pass http://messaging_service$request_uri;
        }
        location /genai/ {
            access_by_lua_file /etc/nginx/oidc.lua;
            proxy_set_header Host $host;
            proxy_pass http://genai$request_uri;
        }

        location /matching/ {
            access_by_lua_file /etc/nginx/oidc.lua;
            proxy_set_header Host $host;
            proxy_pass http://matching_service$request_uri;
        }

        # Fallback
        location / {
            return 404;
        }
    }
}
